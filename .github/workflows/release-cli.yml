name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-linux-freebsd-windows:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, freebsd, windows]
        goarch: [amd64, arm64, arm]
        exclude:
          - goos: windows
            goarch: arm
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          go build -ldflags "-X main.version=${{ github.ref_name }}" -o nak-${{ github.ref_name }}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ./nak-${{ github.ref_name }}-${{ matrix.goos }}-${{ matrix.goarch }}*

  build-darwin:
    runs-on: macos-latest
    strategy:
      matrix:
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Build
        run: |
          go build -ldflags "-X main.version=${{ github.ref_name }}" -o nak-${{ github.ref_name }}-darwin-${{ matrix.goarch }}
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ./nak-${{ github.ref_name }}-darwin-${{ matrix.goarch }}

  smoke-test-linux-amd64:
    runs-on: ubuntu-latest
    needs: 
      - build-linux-freebsd-windows
    steps:
      - uses: actions/checkout@v3
      - name: Download artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.ref_name }} -p "nak-${{ github.ref_name }}-linux-amd64"
          chmod +x nak-${{ github.ref_name }}-linux-amd64
          mv nak-${{ github.ref_name }}-linux-amd64 nak
      - name: Test version
        run: |
          VERSION=$(./nak version)
          echo "version: $VERSION"
          if [ "$VERSION" != "${{ github.ref_name }}" ]; then
            echo "version mismatch!"
            exit 1
          fi
      - name: Test commands
        run: |
          # test key generation
          echo "testing key generation..."
          SECRET_KEY=$(./nak key generate)
          echo "secret key: ${SECRET_KEY:0:20}..."
          PUBLIC_KEY=$(./nak key public $SECRET_KEY)
          echo "public key: $PUBLIC_KEY"
          
          # test event creation
          echo "testing event creation..."
          EVENT=$(./nak event -c "test event" --sec $SECRET_KEY)
          echo "event: ${EVENT:0:100}..."
          
          # test NIP-49 key encryption/decryption
          echo "testing NIP-49 key encryption/decryption..."
          ENCRYPTED_KEY=$(./nak key encrypt $SECRET_KEY "testpassword")
          echo "encrypted key: ${ENCRYPTED_KEY:0:20}..."
          DECRYPTED_KEY=$(./nak key decrypt $ENCRYPTED_KEY "testpassword")
          if [ "$DECRYPTED_KEY" != "$SECRET_KEY" ]; then
            echo "nip-49 encryption/decryption test failed!"
            exit 1
          fi
          
          echo "all tests passed!"

  smoke-test-darwin-arm64:
    runs-on: macos-latest
    needs: 
      - build-darwin
    steps:
      - uses: actions/checkout@v3
      - name: Download artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.ref_name }} -p "nak-${{ github.ref_name }}-darwin-arm64"
          chmod +x nak-${{ github.ref_name }}-darwin-arm64
          mv nak-${{ github.ref_name }}-darwin-arm64 nak
      - name: Test version
        run: |
          VERSION=$(./nak version)
          echo "version: $VERSION"
          if [ "$VERSION" != "${{ github.ref_name }}" ]; then
            echo "version mismatch!"
            exit 1
          fi
      - name: Test commands
        run: |
          # test key generation
          echo "testing key generation..."
          SECRET_KEY=$(./nak key generate)
          echo "secret key: ${SECRET_KEY:0:20}..."
          PUBLIC_KEY=$(./nak key public $SECRET_KEY)
          echo "public key: $PUBLIC_KEY"
          
          # test event creation
          echo "testing event creation..."
          EVENT=$(./nak event -c "test event" --sec $SECRET_KEY)
          echo "event: ${EVENT:0:100}..."
          
          # test NIP-49 key encryption/decryption
          echo "testing NIP-49 key encryption/decryption..."
          ENCRYPTED_KEY=$(./nak key encrypt $SECRET_KEY "testpassword")
          echo "encrypted key: ${ENCRYPTED_KEY:0:20}..."
          DECRYPTED_KEY=$(./nak key decrypt $ENCRYPTED_KEY "testpassword")
          if [ "$DECRYPTED_KEY" != "$SECRET_KEY" ]; then
            echo "nip-49 encryption/decryption test failed!"
            exit 1
          fi
          
          echo "all tests passed!"